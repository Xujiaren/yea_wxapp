/*! alirtc miniapp sdk - ver 1.1.0 created:2021-8-20 4:56:31 PM */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AliRtcMiniAppEngine=t():e.AliRtcMiniAppEngine=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var a=n[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){"use strict";e.exports={JOINCHANNEL:"joinchannel",RECONNECT:"reconnect",KEEPALIVE:"keepalive",PUBLISH:"publish",UNPUBLISH:"unpublish",LEAVECHANNEL:"leavechannel",STATUSREPORT:"statusreport",REFRESHURL:"refreshurl",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",BYE:"bye",ROLEUPDATE:"roleupdate",NOTIFYPUBLISH:"notifypublish",NOTIFYUNPUBLISH:"notifyunpublish",NOTIFYLEAVE:"notifyleave",NOTIFYSTATUS:"notifystatus",NOTIFYJOIN:"notifyJoin",WSCLOSE:"wsclose",WSERROR:"wserror"}},function(e,t,n){"use strict";var i=function(e,t){var n,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),a=[];if(t=t||i.length,e)for(n=0;n<e;n++)a[n]=i[0|Math.random()*t];else{var s;for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",n=0;n<36;n++)a[n]||(s=0|16*Math.random(),a[n]=i[19==n?3&s|8:s])}return a.join("")},a=function(e){for(var t="";t.length<e;)t+=Math.random().toString(36).replace(/[^a-zA-Z0-9]+/g,"").substr(0,e);return t.substr(0,e)};e.exports={createUuid:i,random:a}},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(){function e(){i(this,e),this._eventMap={}}return a(e,[{key:"on",value:function(e,t){e&&(this._eventMap[e]=t)}},{key:"off",value:function(e){e&&this._eventMap[e]&&delete this._eventMap[e]}},{key:"dispatchEvent",value:function(e,t){e&&this._eventMap[e]&&this._eventMap[e](t)}}]),e}();e.exports=s},function(e,t,n){"use strict";e.exports={ERROR_CREATE_WS_FAIL:100001,ERROR_WS_DISCONNECT:100002,ERROR_CHANNELPROFILE_VALUE:100010,ERROR_CHANNELPROFILE:100011,ERROR_ROLE_VALUE:100015,ERROR_CONNECTING_ROLE:100016,ERROR_CHANNELPROFILE_MISMATCHED:100017,ERROR_AUDIENCE_PUBLISH:100018,ERROR_CAN_NOT_MUTE:100019,ERROR_REPEAT_JOIN:100100,ERROR_NOT_LOGIN:100101,ERROR_WRONG_AUTHINFO:100102,ERROR_NO_ROOMSERVERS:100103,ERROR_JOIN_FAIL:100104,ERROR_NO_USER:100200}},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(){function e(){i(this,e)}return a(e,null,[{key:"create",value:function(e,t){var n,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),a=[];if(t=t||i.length,e)for(n=0;n<e;n++)a[n]=i[0|Math.random()*t];else{var s;for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",n=0;n<36;n++)a[n]||(s=0|16*Math.random(),a[n]=i[19==n?3&s|8:s])}return a.join("")}}]),e}();t.default=s},function(e,t,n){e.exports=n(6)},function(e,t,n){"use strict";var i,a;Object.defineProperty(t,"__esModule",{value:!0});var s=("function"==typeof Symbol&&Symbol.iterator,n(7));window&&(window.AliRTCMiniAppEngine=s),i=[],void 0!==(a=function(){return s}.apply(t,i))&&(e.exports=a),t.default=s},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(8),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){i(this,e),this._signaling=new o.default}return a(e,[{key:"setChannelProfile",value:function(e,t,n){this._signaling.setChannelProfile(e,t,n)}},{key:"setRole",value:function(e,t,n){this._signaling.setRole(e,t,n)}},{key:"join",value:function(e,t,n){this._signaling.joinChannel(e,t,n)}},{key:"leave",value:function(e,t){this._signaling.leave(e,t)}},{key:"destroy",value:function(e,t){this._signaling.destroy(e,t)}},{key:"publish",value:function(e,t){this._signaling.publish(e,t)}},{key:"unpublish",value:function(e,t){this._signaling.unpublish(e,t)}},{key:"subscribe",value:function(e,t,n){this._signaling.subscribe(e,t,n)}},{key:"unsubscribe",value:function(e,t,n){this._signaling.unsubscribe(e,t,n)}},{key:"muteLocal",value:function(e,t,n){this._signaling.muteLocal(e,t,n)}},{key:"unmuteLocal",value:function(e,t,n){this._signaling.unmuteLocal(e,t,n)}},{key:"on",value:function(e,t){this._signaling.on(e,t)}},{key:"off",value:function(e){this._signaling.off(e)}},{key:"rejoin",value:function(e,t,n,i){this._signaling.rejoin(e,t,n,i)}}]),e}();e.exports=u},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(9),l=i(r),c=n(2),h=i(c),f=n(3),d=i(f),_=n(0),p=i(_),v=n(13),g=i(v),m=n(14),b=i(m),y=n(15),E=i(y),I=n(16),R=i(I),S=n(23),C=i(S),k=n(24),N=i(k),U=n(1),O={CONNECTIONING:0,CONNECTED:1,DISCONNECTED:2,RECONECTING:3},M=function(e){function t(){a(this,t);var e=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._authInfo=new N.default,e._log=new R.default(e._authInfo),e._apiManager=new C.default,e._userManager=new b.default,e._channelProfileManager=new E.default,e._initRoomServerClient(),e._signalingStatus=O.DISCONNECTED,e._retryIndex=0,e._reconnectUids=[],e}return o(t,e),u(t,[{key:"isConnecting",value:function(){return this._signalingStatus===O.CONNECTIONING}},{key:"isConnected",value:function(){return this._signalingStatus===O.CONNECTED}},{key:"isDisconnected",value:function(){return this._signalingStatus===O.DISCONNECTED}},{key:"isReconnecting",value:function(){return this._signalingStatus===O.RECONECTING}},{key:"setChannelProfile",value:function(e,t,n){O.DISCONNECTED===this._signalingStatus?this._channelProfileManager.setChannelProfile(e)?(this._log.reportSetChannelProfile(0,e),t&&t()):(this._log.reportSetChannelProfile(d.default.ERROR_CHANNELPROFILE_VALUE,e),n&&n({code:d.default.ERROR_CHANNELPROFILE_VALUE,reason:"channelprofile wrong"})):(this._log.reportSetChannelProfile(d.default.ERROR_CHANNELPROFILE,e),n&&n({code:d.default.ERROR_CHANNELPROFILE,reason:"can not set channelprofile"}))}},{key:"setRole",value:function(e,t,n){var i=this;if(O.CONNECTED===this._signalingStatus){var a=this._channelProfileManager.getClientRole(e);this._channelProfileManager.isInteractiveLive?a?this._roomServerClient.roleUpdate(a,function(){i._log.reportSetRole(0,e),i._channelProfileManager.setRole(e),t&&t()},function(t){i._log.reportSetRole(t&&t.code?t.code:-1,e),n&&n(t)}):(this._log.reportSetRole(d.default.ERROR_ROLE_VALUE,e),n&&n({code:d.default.ERROR_ROLE_VALUE,reason:"role wrong"})):(this._log.reportSetRole(0,e),t&&t())}else O.DISCONNECTED===this._signalingStatus?this._channelProfileManager.setRole(e)?(this._log.reportSetRole(0,e),t&&t()):(this._log.reportSetRole(d.default.ERROR_ROLE_VALUE,e),n&&n({code:d.default.ERROR_ROLE_VALUE,reason:"role wrong"})):(this._log.reportSetRole(d.default.ERROR_CONNECTING_ROLE,e),n&&n({code:d.default.ERROR_CONNECTING_ROLE,reason:"connecting锛� try later"}))}},{key:"joinChannel",value:function(e,t,n){var i=this;if(this._authInfo.updateAuthInfo(e))if(O.DISCONNECTED===this._signalingStatus){this._signalingStatus=O.CONNECTIONING;var a=(new Date).getTime();this._getGslb(function(e){var s=(new Date).getTime();i._roomServerClient.joinChannel(e,i._channelProfileManager.getRole(),i._channelProfileManager.getChannelProfile(),i._authInfo,function(n){i._log.start(i._apiManager.getSTSRefreshUrl(i._authInfo.gslb),i._apiManager.serverUrl),i._log.reportJoinRoom((new Date).getTime()-s,0,n.tid,s-a,e,0),i._signalingStatus=O.CONNECTED,t&&t()},function(t){i._log.reportJoinRoom((new Date).getTime()-s,t.code,t.tid,s-a,e,0),i._signalingStatus=O.DISCONNECTED,n&&n(631==t.code?{code:d.default.ERROR_CHANNELPROFILE_MISMATCHED,reason:"channel profile mismatched"}:t)})},function(e){i._log.reportJoinRoom(0,e&&e.code?e.code:-1,0,0,"",0),i._signalingStatus=O.DISCONNECTED,n&&n(e)})}else this._log.reportJoinRoom(0,d.default.ERROR_REPEAT_JOIN,0,0,"",0),n&&n({code:d.default.ERROR_REPEAT_JOIN,reason:"already joined channel"});else this._log.reportJoinRoom(0,d.default.ERROR_WRONG_AUTHINFO,0,0,"",0),n&&n({code:d.default.ERROR_WRONG_AUTHINFO,reason:"wrong authinfo"})}},{key:"rejoin",value:function(e,t,n,i){var a=this;if(!this._checkAuthInfo(this._authInfo))return this._log.reportJoinRoom(0,d.default.ERROR_NOT_LOGIN,0,0,"",1),void(i&&i({code:d.default.ERROR_NOT_LOGIN,reason:"not logged in"}));if(!this._compareAuthInfo(this._authInfo,e))return this._log.reportJoinRoom(0,d.default.ERROR_WRONG_AUTHINFO,0,0,"",1),void(i&&i({code:d.default.ERROR_WRONG_AUTHINFO,reason:"wrong authinfo"}));if(O.DISCONNECTED===this._signalingStatus){this._reconnectUids=t,this._authInfo.updateAuthInfo(e);var s=(new Date).getTime();this._getGslb(function(t){O.RECONECTING;var o=(new Date).getTime();a._roomServerClient.joinChannel(t,a._channelProfileManager.getRole(),a._channelProfileManager.getChannelProfile(),a._authInfo,function(e){a._signalingStatus=O.CONNECTED,a._log.reportJoinRoom((new Date).getTime()-o,0,e.tid,o-s,t,1),n&&n()},function(u){a._log.reportJoinRoom((new Date).getTime()-o,0,u.tid,o-s,t,1),a.joinChannel(e,function(){n&&n()},function(e){a._reconnectUids=[],i&&i(e)})})},function(e){a._log.reportJoinRoom(0,e&&e.code?e.code:-1,0,0,"",0),a._reconnectUids=[],a._signalingStatus=O.DISCONNECTED,i&&i(e)})}else this._log.reportJoinRoom((new Date).getTime()-joinStartTime,0,0,0,"",1),n&&n()}},{key:"publish",value:function(e,t){var n=this;this._channelProfileManager.isInteractiveLive&&this._channelProfileManager.isAudience()?(this._log.reportPublish(this._authInfo.publishCallId,d.default.ERROR_AUDIENCE_PUBLISH,0,0),t&&t({code:d.default.ERROR_AUDIENCE_PUBLISH,reason:"audience can not publish"})):this._roomServerClient.getPublishUrl(function(i){n._roomServerClient.publish(function(){e&&e(i)},t)},t)}},{key:"unpublish",value:function(e,t){this._roomServerClient.unpublish(e,t)}},{key:"subscribe",value:function(e,t,n){var i=this,a=this._userManager.getUserInfo(e),s=(new Date).getTime();a?(a.subscribeId=(0,U.createUuid)(32),this._roomServerClient.subscribe(a.subscribeId,a.callid,function(n){i._log.reportSubscribe(0,0,(new Date).getTime()-s,e),t&&t(n.rtmpplayurl)},function(t){i._log.reportSubscribe(-1,0,(new Date).getTime()-s,e),n&&n(t)})):(this._log.reportSubscribe(-1,0,(new Date).getTime()-s,e),n&&n({code:d.default.ERROR_NO_USER,reason:"user not exist"}))}},{key:"unsubscribe",value:function(e,t,n){var i=this,a=this._userManager.getUserInfo(e),s=(new Date).getTime();a?this._roomServerClient.unsubscribe(a.subscribeId,function(n){i._log.reportUnsubscribe((new Date).getTime()-s,0,n?n.tid:"",e),t&&t()},function(t){i._log.reportUnsubscribe((new Date).getTime()-s,-1,t?t.tid:t,e),n&&n(t)}):(this._log.reportUnsubscribe((new Date).getTime()-s,-1,0,e),n&&n({code:d.default.ERROR_NO_USER,reason:"user not exist"}))}},{key:"leave",value:function(e,t){var n=this,i=(new Date).getTime();this._roomServerClient.leave(function(t){n._log.reportLeaveRoom((new Date).getTime()-i,0,t&&t.tid),n._signalingStatus=O.DISCONNECTED,e&&e()},function(e){n._log.reportLeaveRoom((new Date).getTime()-i,e.code,e.tid),t&&t(e)})}},{key:"muteLocal",value:function(e,t,n){this._roomServerClient.muteLocal(e,t,n)}},{key:"unmuteLocal",value:function(e,t,n){this._roomServerClient.unmuteLocal(e,t,n)}},{key:"destroy",value:function(e,t){this._roomServerClient.leave(e,t)}},{key:"_getGslb",value:function(e,t){var n={appid:this._authInfo.appid,channelid:this._authInfo.channel,userid:this._authInfo.userid,nonce:this._authInfo.nonce,timestamp:this._authInfo.timestamp,session:this._authInfo.sessionId,token:this._authInfo.token,tokensid:!0,tcpturn:!1,arch:"grtn",channelprofile:this._channelProfileManager.getChannelProfile()},i=this._authInfo.gslb[0]+"/gslb/v1/allocate?",a=!0;for(var s in n)a?a=!1:i+="&",i+=s+"="+n[s];wx.request({url:i,data:{},header:{},method:"GET",dataType:"json",responseType:"text",success:function(n){var i=n&&n.data&&n.data.data?n.data.data:[];i?e&&e(i):t&&t({code:d.default.ERROR_NO_ROOMSERVERS,reason:"no roomservers"})},fail:function(e){t&&t(e)}})}},{key:"_initRoomServerClient",value:function(){var e=this;this._roomServerClient=new l.default(this,this._apiManager,this._log,this._authInfo),this._roomServerClient.on(p.default.NOTIFYUNPUBLISH,function(t){var n=e._userManager.userUnpublish(t);n&&e.dispatchEvent(g.default.STREMREMOVE,{uid:n.userid,displayName:n.displayName})}),this._roomServerClient.on(p.default.NOTIFYPUBLISH,function(t){if(e._reconnectUids&&e._reconnectUids.length){var n=e._userManager.compareUserList(e._reconnectUids);e._reconnectUids=[];for(var i=0;i<n.length;++i)e._userManager.updateUser(n[i]),n[i].streams&&n[i].streams.length?e.dispatchEvent(g.default.STREAMADD,{uid:n[i].userid,displayName:n[i].displayName}):e.dispatchEvent(g.default.STREMREMOVE,{uid:n[i].userid,displayName:n[i].displayName})}else for(var a=0;a<t.length;++a)e._userManager.updateUser(t[a]),t[a].streams&&t[a].streams.length?e.dispatchEvent(g.default.STREAMADD,{uid:t[a].userid,displayName:t[a].displayName}):e.dispatchEvent(g.default.STREMREMOVE,{uid:t[a].userid,displayName:t[a].displayName})}),this._roomServerClient.on(p.default.NOTIFYSTATUS,function(t){for(var n=0;n<t.length;++n){var i=e._userManager.updateUserStatus(t[n]);void 0!=i.muteAudio&&(i.muteAudio?e.dispatchEvent(g.default.MUTEAUDIO,{uid:t[n].userid}):e.dispatchEvent(g.default.UNMUTEAUDIO,{uid:t[n].userid})),void 0!=i.muteVideo&&(i.muteVideo?e.dispatchEvent(g.default.MUTEVIDEO,{uid:t[n].userid}):e.dispatchEvent(g.default.UNMUTEVIDEO,{uid:t[n].userid}))}}),this._roomServerClient.on(p.default.WSCLOSE,function(t){var n=e;wx.getSystemInfo({success:function(e){"android"===e.platform&&"interrupted"===t.reason?(n.destroy(),n.dispatchEvent(g.default.ERROR,{code:d.default.ERROR_WS_DISCONNECT,reason:"connection is disconnect, try again"})):n._retryConnect()}})}),this._roomServerClient.on(p.default.WSERROR,function(t){e.isReconnecting()&&setTimeout(function(){e._retryConnect()},4e3)}),this._roomServerClient.on(p.default.NOTIFYJOIN,function(t){for(var n=0;n<t.length;++n)e._userManager.updateUser(t[n])}),this._roomServerClient.on(p.default.NOTIFYLEAVE,function(t){if(Array.isArray(t))for(var n=0;n<t.length;++n)e._userManager.getUser(t[n].userid)&&e._userManager.getUser(t[n].userid).sessionid===t[n].sessionid&&(e._userManager.removeUser(t[n].userid),e.dispatchEvent(g.default.LEAVE,{uid:t[n].userid}));else e._userManager.removeUser(t),e.dispatchEvent(g.default.LEAVE,{uid:t})})}},{key:"_retryConnect",value:function(){var e=this;this._retryIndex>=5?this.dispatchEvent(g.default.ERROR,{code:d.default.ERROR_WS_DISCONNECT,reason:"connection is disconnect, try again"}):(++this._retryIndex,this._signalingStatus=O.RECONECTING,this._roomServerClient.joinChannel(null,this._channelProfileManager.getRole(),this._channelProfileManager.getChannelProfile(),this._authInfo,function(){e._signalingStatus=O.CONNECTED,e._retryIndex=0},function(t){e._signalingStatus=O.DISCONNECTED,setTimeout(function(){e._retryConnect()},4e3)}))}},{key:"_checkAuthInfo",value:function(e){return!!(e&&e.appid&&(e.channelid||e.channel)&&e.userid&&e.nonce&&e.timestamp&&e.token)}},{key:"_compareAuthInfo",value:function(e,t){return!(!this._checkAuthInfo(e)||!this._checkAuthInfo(t)||e.appid!==t.appid||e.channel!==t.channel||e.channelid!==t.channelid||e.userid!==t.userid)}}]),t}(h.default);e.exports=M},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(2),l=i(r),c=n(10),h=i(c),f=n(0),d=i(f),_=n(3),p=i(_),v=n(11),g=i(v),m=n(1),b=function(e){function t(e,n,i,o){a(this,t);var u=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return u._signaling=e,u._apiManager=n,u._log=i,u._authInfo=o,u._hasJoinedChannel=!1,u._keepAliveTimer=0,u._roomServers=null,u._messageCenter=new g.default(n,o),u._initMessageCenter(),u._callbackManager=new h.default,u._publishUrl="",u._callid="",u._seqIndex=0,u._published=!1,u._muteLocalAudio=!1,u._muteLocalVideo=!1,u}return o(t,e),u(t,[{key:"joinChannel",value:function(e,t,n,i,a,s){if(e&&e.slbs&&e.slbs.length){this._apiManager.Init(e.slbs,e.servers);var o=(0,m.createUuid)(32);this._callbackManager.addEventMapCallback(d.default.JOINCHANNEL,o,a,s),this._messageCenter.joinChannel(o,t,n,function(e){},function(e){s&&s(e)})}}},{key:"roleUpdate",value:function(e,t,n){this._messageCenter.roleUpdate(e,function(e){t&&t(e)},function(e){n&&n(e)})}},{key:"getPublishUrl",value:function(e,t){var n=this;this._messageCenter.updateUrl(this._publishUrl,function(t){t&&t.url&&(n._publishUrl=t.url),e&&e(n._publishUrl)},function(e){t&&t(e)})}},{key:"publish",value:function(e,t){var n=this,i=(0,m.createUuid)(32),a=(new Date).getTime();this._callbackManager.addEventMapCallback(d.default.PUBLISH,i,function(t){n._log.reportPublish(n._authInfo.publishCallId,0,i,(new Date).getTime()-a),n._excureFunction(e,t)},function(e){n._log.reportPublish(n._authInfo.publishCallId,e.code,i,(new Date).getTime()-a),n._excureFunction(t,e)}),this._messageCenter.publish(i,function(e){},function(e){n._log.reportPublish(n._authInfo.publishCallId,-1,i,0),n._excureFunction(t,e)})}},{key:"unpublish",value:function(e,t){var n=this,i=(0,m.createUuid)(32),a=(new Date).getTime();this._callbackManager.addEventMapCallback(d.default.UNPUBLISH,i,function(t){n._log.reportUnpublish(n._authInfo.publishCallId,(new Date).getTime()-a,0,i),n._excureFunction(e,t)},function(e){n._log.reportUnpublish(n._authInfo.publishCallId,(new Date).getTime()-a,e.code,i),n._excureFunction(t,e)}),this._messageCenter.unpublish(i,function(e){},function(e){n._log.reportUnpublish(n._authInfo.publishCallId,(new Date).getTime()-a,-1,i),n._excureFunction(t,e)})}},{key:"subscribe",value:function(e,t,n,i){var a=(0,m.createUuid)(32);this._callbackManager.addEventMapCallback(d.default.SUBSCRIBE,a,n,i),this._messageCenter.subscribe(a,e,t,function(e){},function(e){i&&i(e)})}},{key:"unsubscribe",value:function(e,t,n){var i=(0,m.createUuid)(32);this._callbackManager.addEventMapCallback(d.default.UNSUBSCRIBE,i,t,n),this._messageCenter.unsubscribe(i,e,function(e){},function(e){n&&n(e)})}},{key:"leave",value:function(e,t){this._hasJoinedChannel?(this._published&&this.unpublish(),this._messageCenter.leave(function(e){},function(e){})):e&&e()}},{key:"muteLocal",value:function(e,t,n){if(this._published){var i=this._getMuteStatus(e);this._messageCenter.muteLocal(i,function(e){t&&t()},function(e){n&&n(e)})}else n&&n({code:p.default.ERROR_CAN_NOT_MUTE,reason:"need publish first"})}},{key:"unmuteLocal",value:function(e,t,n){var i=this._getUnmuteStatus(e);this._messageCenter.unmuteLocal(i,function(e){t&&t()},function(e){n&&n(e)})}},{key:"_initMessageCenter",value:function(){var e=this;this._messageCenter.on(d.default.JOINCHANNEL,function(t){e._onJoinResponse(t)}),this._messageCenter.on(d.default.LEAVECHANNEL,function(t){e._onLeaveResponse(t)}),this._messageCenter.on(d.default.PUBLISH,function(t){e._onPublishResponse(t)}),this._messageCenter.on(d.default.SUBSCRIBE,function(t){e._onSubscribeResponse(t)}),this._messageCenter.on(d.default.UNSUBSCRIBE,function(t){e._onUnsubscribeResponse(t)}),this._messageCenter.on(d.default.UNPUBLISH,function(t){e._onUnPublishResponse(t)}),this._messageCenter.on(d.default.NOTIFYJOIN,function(t){e._onNotifyJoin(t)}),this._messageCenter.on(d.default.NOTIFYPUBLISH,function(t){e._onNotifyPublish(t)}),this._messageCenter.on(d.default.NOTIFYUNPUBLISH,function(t){e._onNotifyUnPublish(t)}),this._messageCenter.on(d.default.NOTIFYSTATUS,function(t){e._onNotifyStatus(t)}),this._messageCenter.on(d.default.NOTIFYLEAVE,function(t){e._onNotifyLeave(t)}),this._messageCenter.on(d.default.STATUSREPORT,function(t){e._onStatusReportResponse(t)}),this._messageCenter.on(d.default.REFRESHURL,function(t){e._onRefreshUrl(t)}),this._messageCenter.on(d.default.WSCLOSE,function(t){e._signaling.isDisconnected()||(e._messageCenter.disconnect(),e.dispatchEvent(d.default.WSCLOSE,t))}),this._messageCenter.on(d.default.RECONNECT,function(t){e._onReconectResponse(t)}),this._messageCenter.on(d.default.WSERROR,function(t){e._onWSError(t)})}},{key:"_onJoinResponse",value:function(e){this._publishUrl=e.rtmpPushUrl,this._callbackManager.excuteEventMapCallback(d.default.JOINCHANNEL,e.tid,!0,e),this._hasJoinedChannel=!0}},{key:"_onLeaveResponse",value:function(e){this._messageCenter.disconnect(),this._hasJoinedChannel=!1,this._callbackManager.excuteEventMapCallback(d.default.LEAVECHANNEL,e.tid,!0,e)}},{key:"_onPublishResponse",value:function(e){e&&e.tid?(this._published=!0,this._callbackManager.excuteEventMapCallback(d.default.PUBLISH,e.tid,!0,this._publishUrl)):this._callbackManager.excuteEventMapCallback(d.default.PUBLISH,e.tid,!1,e)}},{key:"_onSubscribeResponse",value:function(e){e&&e.tid?this._callbackManager.excuteEventMapCallback(d.default.SUBSCRIBE,e.tid,!0,e):this._callbackManager.excuteEventMapCallback(d.default.SUBSCRIBE,e.tid,!1,e)}},{key:"_onUnsubscribeResponse",value:function(e){e&&e.tid?this._callbackManager.excuteEventMapCallback(d.default.UNSUBSCRIBE,e.tid,!0,e):this._callbackManager.excuteEventMapCallback(d.default.UNSUBSCRIBE,e.tid,!1,e)}},{key:"_onUnPublishResponse",value:function(e){e&&e.tid?this._callbackManager.excuteEventMapCallback(d.default.UNPUBLISH,e.tid,!0,e):this._callbackManager.excuteEventMapCallback(d.default.UNPUBLISH,e.tid,!1,e)}},{key:"_onNotifyJoin",value:function(e){e&&e.length&&this.dispatchEvent(d.default.NOTIFYJOIN,e)}},{key:"_onStatusReportResponse",value:function(e){e&&200==e.code?this._callbackManager.excuteEventMapCallback(d.default.STATUSREPORT,e.tid,!0,null):this._callbackManager.excuteEventMapCallback(d.default.STATUSREPORT,e.tid,!1,e)}},{key:"_onRefreshUrl",value:function(e){e&&200==e.code?this._callbackManager.excuteEventMapCallback(d.default.REFRESHURL,e.tid,!0,e.data):this._callbackManager.excuteEventMapCallback(d.default.REFRESHURL,e.tid,!1,e)}},{key:"_onReconectResponse",value:function(e){e&&200==e.code?(this._publishUrl=e.data.pushstreamurl,this._callbackManager.excuteEventMapCallback(d.default.RECONNECT,null,!0,null),e.data.users&&e.data.users.length&&this.dispatchEvent(d.default.NOTIFYPUBLISH,e.data.users)):631==e.code?this._callbackManager.excuteEventMapCallback(d.default.RECONNECT,null,!1,{code:p.default.ERROR_CHANNELPROFILE_MISMATCHED,reason:"channel profile mismatched"}):this._callbackManager.excuteEventMapCallback(d.default.RECONNECT,null,!1,e)}},{key:"_onNotifyPublish",value:function(e){e&&e.length&&this.dispatchEvent(d.default.NOTIFYPUBLISH,e)}},{key:"_onNotifyUnPublish",value:function(e){e&&this.dispatchEvent(d.default.NOTIFYUNPUBLISH,e)}},{key:"_onNotifyStatus",value:function(e){if(e&&e.length){for(var t=0;t<e.length;++t){var n=this._parseStatusValue(e[t].status);e[t].muteAudio=n.muteAudio,e[t].muteVideo=n.muteVideo}this.dispatchEvent(d.default.NOTIFYSTATUS,e)}}},{key:"_onNotifyLeave",value:function(e){this.dispatchEvent(d.default.NOTIFYLEAVE,e)}},{key:"_onWSError",value:function(e){this._signaling.isReconnecting()&&this._messageCenter.disconnect(),this.dispatchEvent(d.default.WSERROR,e)}},{key:"_getMuteStatus",value:function(e){return"audio"===e?(this._log.reportMuteLocalMic(!0),this._muteLocalAudio?"":(this._muteLocalAudio=!0,this._getStatusValue())):"video"===e?(this._log.reportMuteLocalCamera(!0),this._muteLocalVideo?"":(this._muteLocalVideo=!0,this._getStatusValue())):"all"===e?(this._log.reportMuteLocalMic(!0),this._log.reportMuteLocalCamera(!0),this._muteLocalAudio&&this._muteLocalVideo?"":(this._muteLocalAudio=!0,this._muteLocalVideo=!0,this._getStatusValue())):void 0}},{key:"_getUnmuteStatus",value:function(e){return"audio"===e?(this._log.reportMuteLocalMic(!1),this._muteLocalAudio?(this._muteLocalAudio=!1,this._getStatusValue()):""):"video"===e?(this._log.reportMuteLocalCamera(!1),this._muteLocalVideo?(this._muteLocalVideo=!1,this._getStatusValue()):""):"all"===e?(this._log.reportMuteLocalMic(!1),this._log.reportMuteLocalCamera(!1),this._muteLocalAudio||this._muteLocalVideo?(this._muteLocalAudio=!1,this._muteLocalVideo=!1,this._getStatusValue()):""):void 0}},{key:"_getStatusValue",value:function(){for(var e=this._muteLocalAudio?8:0,t=this._muteLocalVideo?16:0,n=(5+e+t).toString(16);n.length<16;)n="0"+n;return n}},{key:"_parseStatusValue",value:function(e){var t=parseInt(e,16),n=!!(2&t),i=!!(8&t),a=!!(16&t);return{muteAudio:n||i,muteVideo:a}}},{key:"_excureFunction",value:function(e,t){e&&e(t)}}]),t}(l.default);e.exports=b},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(0),o=(function(e){e&&e.__esModule}(s),function(){function e(){i(this,e),this._callBackMap={}}return a(e,[{key:"addEventMapCallback",value:function(e,t,n,i){e&&(this._initEvent(e),this._callBackMap[e].push({tid:t,onSuccess:n,onFail:i}))}},{key:"excuteEventMapCallback",value:function(e,t,n,i){if(!e)return"";var a=null;if(this._callBackMap[e])for(var s=0;s<this._callBackMap[e].length;++s)if(this._callBackMap[e][s].tid==t)return a=this._callBackMap[e].splice(s,1)[0],n?a.onSuccess&&a.onSuccess(i):a.onFail&&a.onFail(i),e}},{key:"_initEvent",value:function(e){this._callBackMap[e]||(this._callBackMap[e]=[])}}]),e}());e.exports=o},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(0),l=i(r),c=n(2),h=i(c),f=n(3),d=i(f),_=n(1),p=n(12),v=i(p),g=function(e){function t(e,n){a(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._apiManager=e,i._authInfo=n,i._dispose=!0,i._seqIndex=0,i._messageCache=new v.default,i}return o(t,e),u(t,[{key:"joinChannel",value:function(e,t,n,i,a){var s=this,o={sdkagent:"",configure:{DownlinkStreamMerge:!0,"1v1TccForwardEnable":!0,SubSuperStreamEnable:!0,EnableVideoNackFECV1:!1,MPUSuperClientEnable:!1,NeedSDPUnified:!1,WebSDK:"for web sdk",NoExtraConfig:!1,EnableBWEStatusReport:!1,clientrole:t,channelprofile:n,wechat:!0}},u=this._apiManager.JoinUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId;this._messageCache.addMessage({tid:e,type:l.default.JOINCHANNEL,url:u,param:o}),this._request(u,o,function(t){t&&t.data&&0==t.data.code?(s._dispose=!1,s._pollingRequest(),i(e)):a({code:d.default.ERROR_JOIN_FAIL,reason:t.data.description})},function(e){a({code:d.default.ERROR_JOIN_FAIL,reason:e.message})})}},{key:"leave",value:function(e,t){var n=(0,_.createUuid)(32),i=this._apiManager.LeaveUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+n+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,a={};this._messageCache.addMessage({tid:n,type:l.default.LEAVECHANNEL,url:i,param:a}),this._request(i,a,function(t){e(t)},function(e){t(e)})}},{key:"updateUrl",value:function(e,t,n){var i=(0,_.createUuid)(32),a=this._apiManager.UpdateRtmpUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+i+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,s={url:e};this._request(a,s,function(e){e&&e.data&&0==e.data.code?t(e.data.data):n({code:d.default.ERROR_JOIN_FAIL,reason:e.data.description})},function(e){n(e)})}},{key:"publish",value:function(e,t,n){var i=this._apiManager.PublishUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,a={jsep:{type:"offer",sdp:""},streams:[{label:"sophon_audio",mslabel:"sophon_stream",substreams:1,temporalLayers:3,type:"audio",state:"active",audioprofile:"ENGINE_HIGH_QUALITY_MODE",alias:""},{label:"sophon_video_camera_large",mslabel:"sophon_stream",substreams:1,temporalLayers:3,type:"video",state:"active",videoprofile:"UD_480_640P_15",alias:""}]};this._messageCache.addMessage({tid:e,type:l.default.PUBLISH,url:i,param:a}),this._request(i,a,function(n){n&&n.data&&0==n.data.code&&t(e)},function(e){n(e)})}},{key:"unpublish",value:function(e,t,n){var i=this,a=this._apiManager.UnPublishUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,s={};this._request(a,s,function(n){n&&n.data&&0==n.data.code&&(i._messageCache.addMessage({tid:e,type:l.default.UNPUBLISH,url:a,param:s}),t(n.data.data))},function(e){n(e)})}},{key:"subscribe",value:function(e,t,n,i,a){var s=this._apiManager.SubscribeUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+t+"&callee="+n,o={streams:[{mslabel:"sophon_stream",label:"sophon_video_camera_large",type:"video",temporalLayer:2,substream:0,videoprofile:"",audioprofile:""},{mslabel:"sophon_stream",label:"sophon_audio",type:"audio",temporalLayer:1,substream:0,videoprofile:"",audioprofile:""}]};this._messageCache.addMessage({tid:e,type:l.default.SUBSCRIBE,url:s,param:o}),this._request(s,o,function(e){e&&e.data&&0==e.data.code&&i(e.data.data)},function(e){a(e)})}},{key:"unsubscribe",value:function(e,t,n,i){var a=this._apiManager.UnSubscribeUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+t;this._messageCache.addMessage({tid:e,type:l.default.UNSUBSCRIBE,url:a,param:{}}),this._request(a,{},function(e){e&&e.data&&0==e.data.code&&n(e.data.data)},function(e){i(e)})}},{key:"muteLocal",value:function(e,t,n){var i=(0,_.createUuid)(32),a=this._apiManager.StatusUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+i+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,s={status:{userid:this._authInfo.userid,status:e}};this._request(a,s,function(e){e&&e.data&&0==e.data.code&&t(e.data.data)},function(e){n(e)})}},{key:"unmuteLocal",value:function(e,t,n){var i=(0,_.createUuid)(32),a=this._apiManager.StatusUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+i+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,s={status:{userid:this._authInfo.userid,status:e}};this._request(a,s,function(e){e&&e.data&&0==e.data.code&&t(e.data.data)},function(e){n(e)})}},{key:"roleUpdate",value:function(e,t,n){var i=(0,_.createUuid)(32),a=this._apiManager.RoleUpdate+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+i+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,s={seq:this._seq,clientrole:e};this._request(a,s,function(e){e&&e.data&&0==e.data.code&&t(e.data.data)},function(e){n(e)})}},{key:"disconnect",value:function(){this._dispose=!0,this._seqIndex=0}},{key:"_request",value:function(e,t,n,i){t&&(t.seq=this._seqIndex),++this._seqIndex,wx.request({url:e,data:t,header:{Accept:"application/json","content-type":"application/json"},method:"POST",responseType:"text",success:function(e){n&&n(e)},fail:function(e){i&&i(e)}})}},{key:"_pollingRequest",value:function(){var e=this;if(!this._dispose){var t=(0,_.createUuid)(32),n=this._apiManager.PollingUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+t+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,i={};this._request(n,i,function(t){t&&t.data&&0==t.data.code&&e._recvMessage(t.data.data),e._pollingRequest()},function(t){e._pollingRequest()})}}},{key:"_recvMessage",value:function(e){if(e){var t=this._messageCache.getMessage(e.tid);if(t)switch(t){case l.default.JOINCHANNEL:this._onJoinSuccess(e);break;case l.default.PUBLISH:this._onPublishSuccess(e);break;case l.default.UNPUBLISH:this._onUnpublishSuccess(e);break;case l.default.SUBSCRIBE:this._onSubscribeSuccess(e);break;case l.default.UNSUBSCRIBE:this._onUnsubscribeSuccess(e);break;case l.default.LEAVECHANNEL:this._onLeaveSuccess(e)}else switch(e.event){case"statusnotify":this._onNotifyStatus(e);break;case"join":this._onNotifyJoin(e);break;case"publishers":this._onNotifyPublish(e);break;case"unpublish":this._onNotifyUnpublish(e);break;case"leave":this._onNotifyLeave(e)}}}},{key:"_onJoinSuccess",value:function(e){this.dispatchEvent(l.default.JOINCHANNEL,e)}},{key:"_onNotifyStatus",value:function(e){e&&e.status&&(this._requestResponse(e.tid,e.event),this.dispatchEvent(l.default.NOTIFYSTATUS,e.status))}},{key:"_onNotifyJoin",value:function(e){e&&e.peers&&(this._requestResponse(e.tid,e.event),this.dispatchEvent(l.default.NOTIFYJOIN,e.peers))}},{key:"_onPublishSuccess",value:function(e){this.dispatchEvent(l.default.PUBLISH,e)}},{key:"_onUnpublishSuccess",value:function(e){this.dispatchEvent(l.default.UNPUBLISH,e)}},{key:"_onSubscribeSuccess",value:function(e){this.dispatchEvent(l.default.SUBSCRIBE,e)}},{key:"_onUnsubscribeSuccess",value:function(e){this._requestResponse(e.tid,e.event),this.dispatchEvent(l.default.UNSUBSCRIBE,e)}},{key:"_onClose",value:function(e){this.dispatchEvent(l.default.WSCLOSE,e)}},{key:"_onLeaveSuccess",value:function(e){this._dispose=!0,this.dispatchEvent(l.default.LEAVECHANNEL,e)}},{key:"_onStatusReport",value:function(e){this.dispatchEvent(l.default.STATUSREPORT,e)}},{key:"_onRefreshUrl",value:function(e){this.dispatchEvent(l.default.REFRESHURL,e)}},{key:"_onNotifyPublish",value:function(e){this._requestResponse(e.tid,"publishers"),e&&e.publishers&&this.dispatchEvent(l.default.NOTIFYPUBLISH,e.publishers)}},{key:"_onNotifyUnpublish",value:function(e){this._requestResponse(e.tid,l.default.NOTIFYUNPUBLISH),e.userid&&this.dispatchEvent(l.default.NOTIFYUNPUBLISH,e.userid)}},{key:"_onNotifyLeave",value:function(e){this._requestResponse(e.tid,"leave"),e.userid&&this.dispatchEvent(l.default.NOTIFYLEAVE,[{userid:e.userid}])}},{key:"_onBye",value:function(e){}},{key:"_requestResponse",value:function(e,t){var n=this._apiManager.PollingResponseUrl+"?&appid="+this._authInfo.appid+"&userid="+this._authInfo.userid+"&room="+this._authInfo.channel+"&tid="+e+"&server="+this._apiManager.serverUrl+"&tokensid="+!1+"&tcpturn="+!1+"&token="+this._authInfo.token+"&session="+this._authInfo.sessionId+"&nonce="+this._authInfo.nonce+"&timestamp="+this._authInfo.timestamp+"&display-name="+this._authInfo.displayName+"&callid="+this._authInfo.publishCallId,i={code:0,description:"success",data:{event:t}};this._request(n,i,function(e){},function(e){})}}]),t}(h.default);e.exports=g},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(){function e(){i(this,e),this._arr=[]}return a(e,[{key:"addMessage",value:function(e){this._arr.push(e)}},{key:"getMessage",value:function(e){for(var t=0;t<this._arr.length;++t)if(this._arr[t].tid===e){var n=this._arr[t].type;return this._arr.splice(t,1),n}return null}}]),e}();e.exports=s},function(e,t,n){"use strict";e.exports={ERROR:"error",STREAMADD:"stream-added",STREMREMOVE:"stream-removed",MUTEAUDIO:"mute-audio",MUTEVIDEO:"mute-video",UNMUTEAUDIO:"unmute-audio",UNMUTEVIDEO:"unmute-video",LEAVE:"leave"}},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(){function e(){i(this,e),this._userMap={}}return a(e,[{key:"userUnpublish",value:function(e){return this._userMap[e]?(this._userMap[e].streams=[],this._userMap[e]):null}},{key:"updateUser",value:function(e){e&&e.userid&&(this._userMap[e.userid]=e)}},{key:"updateUserStatus",value:function(e){var t={muteAudio:void 0,muteVideo:void 0};if(e){var n=this._userMap[e.userid];n&&(!0===n.muteAudio?!1===e.muteAudio&&(n.muteAudio=!1,t.muteAudio=!1):!0===e.muteAudio&&(n.muteAudio=!0,t.muteAudio=!0),!0===n.muteVideo?!1===e.muteVideo&&(n.muteVideo=!1,t.muteVideo=!1):!0===e.muteVideo&&(n.muteVideo=!0,t.muteVideo=!0))}return t}},{key:"getUser",value:function(e){return this._userMap[e]?this._userMap[e]:null}},{key:"getUserInfo",value:function(e){return this._userMap[e]?this._userMap[e]:null}},{key:"removeUser",value:function(e){this._userMap[e]&&delete this._userMap[e]}},{key:"getUserList",value:function(){var e=[];for(var t in this._userMap)e.push(this._userMap[t]);return e}},{key:"compareUserList",value:function(e){var t=[];if(e){for(var n=0;n<e.length;++n){var i=e[n].userid;i&&(!this._userMap[i]||this._userMap[i].streams||this._userMap[i].streams.length)&&t.push({userid:i,displayName:this._userMap[i].displayName,type:"removed"})}for(var a in this._userMap){for(var s=!1,o=0;o<e.length;++o)if(e[o].userid===a){s=!0;break}!s&&this._userMap[a].streams&&this._userMap[a].streams.length>0&&t.push({userid:a,displayName:this._userMap[a].displayName,type:"add"})}}return t}}]),e}();e.exports=s},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s={Communication:0,InteractiveLive:1},o={broadcaster:"broadcaster",audience:"audience"},u=function(){function e(){i(this,e),this._channelProfile=s.Communication,this._role=o.broadcaster}return a(e,[{key:"isInteractiveLive",value:function(){return this._channelProfile===s.InteractiveLive}},{key:"isAudience",value:function(){return this._role===o.audience}},{key:"getClientRole",value:function(e){return o.audience===e?"live":o.broadcaster===e?"interactive":""}},{key:"setChannelProfile",value:function(e){return(s.Communication===e||s.InteractiveLive===e)&&(this._channelProfile=e,!0)}},{key:"getChannelProfile",value:function(){return s.InteractiveLive===this._channelProfile?"interactive_live":"communication"}},{key:"getRole",value:function(){return s.InteractiveLive===this._channelProfile?o.audience===this._role?"live":"interactive":""}},{key:"setRole",value:function(e){return(o.broadcaster===e||o.audience===e)&&(this._role=e,!0)}}]),e}();e.exports=u},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(17),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=n(18),r=function(){function e(t){i(this,e),this._logClient=new u.LogClient(t)}return a(e,[{key:"start",value:function(e,t){this._logClient.start(e)}},{key:"stopUpdateToken",value:function(){this._logClient.stopUpdateToken()}},{key:"reportJoinRoom",value:function(e,t,n,i,a,s){this._log({evetid:o.default.JOINCHANNEL,args:this._data2String({joitm:e,rslt:t,mode:"https",tid:n,gslbtm:i,gslbrslt:JSON.stringify(a),rj:s})})}},{key:"reportLeaveRoom",value:function(e,t,n){this._log({evetid:o.default.LEAVECHANNEL,args:this._data2String({lvetm:e,rslt:t,tid:n})}),this._logClient.clear()}},{key:"reportPublish",value:function(e,t,n,i){this._log({evetid:o.default.PUBLISH,args:this._data2String({calid:e,isvl:1,isvss:0,isaudio:1,hgt:0,wdth:0,rslt:t,tid:n,pubtm:i})})}},{key:"reportUnpublish",value:function(e,t,n,i){this._log({evetid:o.default.UNPUBLISH,args:this._data2String({calid:e,unpubtm:t,rslt:n,tid:i})})}},{key:"reportSubscribe",value:function(e,t,n,i){this._log({evetid:o.default.SUBSCRIBE,args:this._data2String({calid:"",rmtid:"",isvl:0,isvs:0,isvss:0,isaudio:0,rslt:e,tid:t,subtm:n,uid:i})})}},{key:"reportUnsubscribe",value:function(e,t,n,i){this._log({evetid:o.default.UNSUBSCRIBE,args:this._data2String({calid:"",rmtid:"",unsubtm:e,rslt:t,tid:n,uid:i})})}},{key:"reportSetChannelProfile",value:function(e,t){this._log({evetid:o.default.SETCHANNELPROFILE,args:this._data2String({rslt:e,pf:t})})}},{key:"reportSetRole",value:function(e,t){this._log({evetid:o.default.SETCLIENTROLE,args:this._data2String({rslt:e,rl:t})})}},{key:"reportMuteLocalCamera",value:function(e){this._log({evetid:o.default.MUTECAMERA,args:this._data2String({mt:e})})}},{key:"reportMuteLocalMic",value:function(e){this._log({evetid:o.default.MUTEMIC,args:this._data2String({mt:e})})}},{key:"_log",value:function(e){this._logClient.sendReport(e)}},{key:"_data2String",value:function(e){var t="";for(var n in e)t.length&&(t+="|"),t+=n+"="+e[n];return t}}]),e}();t.default=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={JOINCHANNEL:10010,LEAVECHANNEL:10020,PUBLISH:10030,UNPUBLISH:10040,SUBSCRIBE:10050,UNSUBSCRIBE:10060,SETCHANNELPROFILE:20031,SETCLIENTROLE:20032,MUTECAMERA:20060,MUTEMIC:20061}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.LogClient=void 0;var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=n(19),u=i(o),r=n(20),l=i(r),c=n(21),h=i(c),f=n(22);t.LogClient=function(){function e(t){a(this,e),this._index=0,this._authInfo=t,this._messageCache=new f.MessageCache,this._logUrl="https://rtc-sz-client.cn-shenzhen.log.aliyuncs.com/logstores/client_sz/track"}return s(e,[{key:"start",value:function(e){this._initParam(),this._param.apid=this._authInfo.appid,this._param.usrid=this._authInfo.userid,this._param.sesid=this._authInfo.sessionId,this._param.channelid=this._authInfo.channel,this._param.usrn=this._authInfo.displayName,this.clear()}},{key:"stopUpdateToken",value:function(){this.clear()}},{key:"sendReport",value:function(e){this._initParam(),e.idx=this._index,e.tm=(new Date).getTime(),++this._index,0===this._messageCache.getCacheLength()&&this._param.apid?this._realSendReport(e):this._messageCache.addCache(e)}},{key:"clear",value:function(){var e=this;if(this._messageCache.getCacheLength()){this._messageCache.getCache().forEach(function(t){e._realSendReport(t)})}}},{key:"_initParam",value:function(){this._param||(this._param={osn:u.default.systemName,osv:u.default.systemVersion,udid:l.default.uuid,statsvrs:"0.6.1",deb:u.default.brand,sdkv:h.default.version,bt:"miniapp",envir:h.default.evn,bv:u.default.version},this._authInfo&&(this._param.apid=this._authInfo.appid,this._param.usrid=this._authInfo.userid,this._param.sesid=this._authInfo.sessionId,this._param.channelid=this._authInfo.channel,this._param.usrn=this._authInfo.displayName))}},{key:"_realSendReport",value:function(e){var t={};for(var n in this._param)t[n]=this._param[n];for(var i in e)t[i]=e[i];if(wx&&wx.request){var a=this._logUrl+"?"+this._data2String(t);wx.request({url:a,method:"GET",success:function(){},fail:function(e){}})}}},{key:"_data2String",value:function(e){var t="";e&&!e.APIVersion&&(e.APIVersion="0.6.0");for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=n+"="+e[n]);return t}}]),e}()},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=function(){function e(){i(this,e)}return a(e,null,[{key:"_getSystemInfo",value:function(){e._systemName&&e._systemVersion&&e._version&&e._brand||wx.getSystemInfo({success:function(t){e._systemName=t.platform,e._systemVersion=t.system,e._version=t.version,e._brand=t.brand}})}},{key:"systemName",get:function(){return e._getSystemInfo(),e._systemName}},{key:"systemVersion",get:function(){return e._getSystemInfo(),e._systemVersion&&2===e._systemVersion.split(" ").length?e._systemVersion.split(" ")[1]:0}},{key:"systemMainVersion",get:function(){return e._getSystemInfo(),e._systemVersion?parseInt(e._systemVersion.split(".")[0]):0}},{key:"version",get:function(){return e._getSystemInfo(),e._version}},{key:"brand",get:function(){return e._getSystemInfo(),e._brand}}]),e}();t.default=s},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(4),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){i(this,e)}return a(e,null,[{key:"get",value:function(e){var t=e+"";wx.getStorage({key:t,success:function(e){return unescape(e.data)},fail:function(e){return""}})}},{key:"set",value:function(e,t){wx.setStorage({key:e,data:escape(t)})}},{key:"uuid",get:function(){var t=e.get("rtc_uuid");return t||(t=o.default.create(32),e.set("rtc_uuid",t,365)),t}}]),e}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={evn:"PRODUCT",version:"1.1.0"};t.default=i},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.MessageCache=function(){function e(){i(this,e),this._cacheArr=[]}return a(e,[{key:"getCacheLength",value:function(){return this._cacheArr.length}},{key:"addCache",value:function(e){this._cacheArr.push(e)}},{key:"getAllCache",value:function(){return this._cacheArr.splice(0)}},{key:"getCache",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;return e<=0||e>this._cacheArr.length?this._cacheArr.splice(0):this._cacheArr.splice(0,e)}}]),e}()},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s={Login:"/app/v1/login",Gslb:"/gslb/v1/allocate",STSRefresh:"/gslb/v1/stsupdate",Auth:"/auth/v1/token",Create:"/signaling/v1/create",Join:"/signaling/v1/join",Leave:"/signaling/v1/leave",Publish:"/signaling/v1/publish",Republish:"/signaling/v1/republish",UnPublish:"/signaling/v1/unpublish",ICECandidate:"/signaling/v1/icecandidate",Subscribe:"/signaling/v1/subscribe",ReSubscribe:"/signaling/v1/resubscribe",UnSubscribe:"/signaling/v1/unsubscribe",Answer:"/signaling/v1/answer",Polling:"/signaling/v1/polling",PollingResponse:"/signaling/v1/response",RoleUpdate:"/signaling/v1/roleupdate",UpdateRtmpUrl:"/signaling/v1/refreshrtmpurl",Status:"/signaling/v1/status"},o=function(){function e(){i(this,e),this._availableSlb="",this._availableServer=""}return a(e,[{key:"Init",value:function(e,t){e&&e.length?this._availableSlb=e[0]:this._availableSlb="",t&&t.length?this._availableServer=t[0]:this._availableServer=""}},{key:"getGslbUrl",value:function(e){return e&&e.length?e[0]+s.Gslb:""}},{key:"getSTSRefreshUrl",value:function(e){return e&&e.length?e[0]+s.STSRefresh:""}},{key:"serverUrl",get:function(){return this._availableServer}},{key:"AnswerUrl",get:function(){return this._availableSlb+s.Answer}},{key:"UnSubscribeUrl",get:function(){return this._availableSlb+s.UnSubscribe}},{key:"ReSubscribeUrl",get:function(){return this._availableSlb+s.ReSubscribe}},{key:"SubscribeUrl",get:function(){return this._availableSlb+s.Subscribe}},{key:"UnPublishUrl",get:function(){return this._availableSlb+s.UnPublish}},{key:"PublishUrl",get:function(){return this._availableSlb+s.Publish}},{key:"UpdateRtmpUrl",get:function(){return this._availableSlb+s.UpdateRtmpUrl}},{key:"RepublishUrl",get:function(){return this._availableSlb+s.Republish}},{key:"ICECandidateUrl",get:function(){return this._availableSlb+s.ICECandidate}},{key:"PollingResponseUrl",get:function(){return this._availableSlb+s.PollingResponse}},{key:"PollingUrl",get:function(){return this._availableSlb+s.Polling}},{key:"LeaveUrl",get:function(){return this._availableSlb+s.Leave}},{key:"JoinUrl",get:function(){return this._availableSlb+s.Join}},{key:"RoleUpdate",get:function(){return this._availableSlb+s.RoleUpdate}},{key:"StatusUrl",get:function(){return this._availableSlb+s.Status}},{key:"WSUrl",get:function(){return this._availableSlb.replace("https","wss")+"/signaling/v2/ws"}}]),e}();t.default=o},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(4),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=n(1),r=function(){function e(){i(this,e),this._displayName="",this._sessionId="",this._userid="",this._channel="",this._appid="",this._nonce="",this._timestamp=0,this._gslb=[],this._token="",this._publishCallid="",this._turn={},this._message="",this._type=""}return a(e,[{key:"updateAuthInfo",value:function(e){return!(!e||(this._message=this._validateAuthInfo(e),this._message))&&(this._sessionId=o.default.create(32),this._userid=e.userid,this._channel=void 0!==e.channel?e.channel:e.channelid,this._appid=e.appid,this._nonce=e.nonce,this._timestamp=e.timestamp,this._gslb=e.gslb,this._token=e.token,this._publishCallid=(0,u.random)(32),this._displayName=e.displayName||e.userid,this._type="grtn",e.turn?this._turn={username:this._userid+"?appid="+this._appid+"&session="+this._sessionId+"&channel="+this._channel+"&nonce="+this._nonce+"&timestamp="+this._timestamp,credential:e.turn.password}:this._turn={username:this._userid+"?appid="+this._appid+"&session="+this._sessionId+"&channel="+this._channel+"&nonce="+this._nonce+"&timestamp="+this._timestamp+"&tokensid=false",credential:"hello1234"},!0)}},{key:"getErrorMessage",value:function(){return this._message}},{key:"_validateAuthInfo",value:function(e){var t="棰戦亾閴存潈浠ょ墝鍙傛暟#涓嶈兘涓虹┖",n="";return e.appid?e.channel||e.channelid?e.nonce?e.userid?e.timestamp?e.token?e.gslb||(n="gslb"):n="token":n="timestamp":n="userid":n="nonce":n="channel":n="appid",n?t=t.replace("#",n):/[^\d^\w^\-]+/.test(e.userid)?"鐢ㄦ埛鍚�(userid)鍙兘涓哄瓧姣嶆垨鏁板瓧":""}},{key:"displayName",get:function(){return this._displayName},set:function(e){this._displayName=e}},{key:"userid",get:function(){return this._userid},set:function(e){this._userid=e}},{key:"channel",get:function(){return this._channel},set:function(e){this._channel=e}},{key:"channelid",set:function(e){this._channel=e}},{key:"appid",get:function(){return this._appid},set:function(e){this._appid=e}},{key:"nonce",get:function(){return this._nonce},set:function(e){this._nonce=e}},{key:"timestamp",get:function(){return this._timestamp},set:function(e){this._timestamp=e}},{key:"gslb",get:function(){return this._gslb},set:function(e){this._gslb=e}},{key:"token",get:function(){return this._token},set:function(e){this._token=e}},{key:"publishCallId",get:function(){return this._publishCallid},set:function(e){this._publishCallid=e}},{key:"sessionId",get:function(){return this._sessionId}},{key:"turn",get:function(){return this._turn}},{key:"type",get:function(){return this._type}},{key:"isGrtn",get:function(){return"grtn"===this._type}}]),e}();t.default=r}])});
